FROM rockylinux:9.3 AS base

# Add --setopt=sslverify=false to bypass the proxy SSL inspection issues
RUN dnf -y --setopt=sslverify=false update && \
    dnf install -y --setopt=sslverify=false \
        wget telnet jq vim sudo gnupg openssh-server openssh-clients \
        procps-ng net-tools iproute iputils less diffutils watchdog epel-release \
        docker emacs-nox git make && \
    dnf clean all && rm -rf /var/cache/dnf

# Install EDB Repository and TPA 
# Added -k (or --insecure) to curl to bypass the SSL check on the setup script
RUN curl -1sSLf -k 'https://downloads.enterprisedb.com/********/enterprise/setup.rpm.sh' | sudo -E bash && \
    dnf install -y --setopt=sslverify=false tpaexec && \
    dnf clean all && rm -rf /var/cache/dnf

# CRB / libmemcached Setup 
RUN dnf install -y --setopt=sslverify=false 'dnf-command(config-manager)' && \
    dnf config-manager --set-enabled crb && \
    dnf install -y --setopt=sslverify=false libmemcached-awesome && \
    dnf clean all && rm -rf /var/cache/dnf

# --- 4. Configuration and Entrypoint ---
COPY id_rsa /
COPY id_rsa.pub /
COPY authorized_keys /

# Expose ports
EXPOSE 22 

COPY entrypoint.sh /
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
